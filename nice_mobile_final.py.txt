import streamlit as st
import requests
import time
from datetime import datetime, timedelta

# [ì„¤ì •] ì•± ê¸°ë³¸ êµ¬ì„±
st.set_page_config(page_title="NICE-M Full Layer", page_icon="ğŸ“¡", layout="centered", initial_sidebar_state="collapsed")

# [CSS] ìŠ¤íƒ€ì¼ë§ (ê°€ë…ì„± ê°•í™”)
st.markdown("""<style>
    .layer-box {padding:10px; border-radius:10px; margin-bottom:10px; border:1px solid #333;}
    .l-pass {background-color:rgba(0, 230, 118, 0.1); border-color:#00e676;}
    .l-fail {background-color:rgba(255, 82, 82, 0.1); border-color:#ff5252;}
    .l-neu {background-color:rgba(255, 255, 255, 0.05); border-color:#555;}
    .big-score {font-size:40px; font-weight:bold; text-align:center;}
</style>""", unsafe_allow_html=True)

# [1. ë°ì´í„° ìˆ˜ì§‘ ê¸°ê´€]
class Data_HQ:
    def get_market_data(self, ex, sym):
        try:
            if ex == 'Upbit':
                url = f"https://api.upbit.com/v1/ticker?markets={sym}"
                res = requests.get(url, timeout=1).json()[0]
                price = float(res['trade_price'])
                chg = float(res['signed_change_rate']) * 100
                vol = float(res['acc_trade_price_24h'])
            else:
                clean = sym.replace("KRW-", "")
                url = f"https://api.bithumb.com/public/ticker/{clean}_KRW"
                res = requests.get(url, timeout=1).json()['data']
                price = float(res['closing_price'])
                chg = float(res['fluctate_rate_24H'])
                vol = float(res['acc_trade_value_24H'])
        except: price, chg, vol = 0, 0, 0
        return price, chg, vol

    def get_kimp(self, krw_price, sym):
        try:
            clean = sym.replace("KRW-", "").replace("BTC_", "") + "USDT"
            url = f"https://api.binance.com/api/v3/ticker/price?symbol={clean.upper()}"
            usd = float(requests.get(url, timeout=1).json()['price'])
            global_krw = usd * 1445.0 # í™˜ìœ¨ ê³ ì •
            kimp = ((krw_price / global_krw) - 1) * 100
            return kimp, global_krw
        except: return 0.0, 0.0

    def get_news(self):
        try:
            url = "https://api-manager.upbit.com/api/v1/notices?page=1&per_page=5&thread_name=general"
            latest = requests.get(url, timeout=1).json()['data']['list'][0]
            created = datetime.fromisoformat(latest['created_at'].replace('Z', '+00:00')) + timedelta(hours=9)
            ago = int((datetime.now().astimezone() - created).total_seconds() / 60)
            critical = any(k in latest['title'] for k in ["ìƒì¥", "ì¶”ê°€", "ë§ˆì¼“"]) and (ago < 60)
            return {'critical': critical, 'title': latest['title'], 'ago': ago}
        except: return {'critical': False, 'title': "ë¡œë”© ì‹¤íŒ¨", 'ago': 999}

# [2. NICE ë ˆì´ì–´ ë¶„ì„ ì—”ì§„]
class Layer_Engine:
    def analyze(self, price, chg, vol, kimp, news):
        layers = {}
        
        # L0: Macro (BTC ê¸°ì¤€ ì¶”ì„¸) - ì•½ì‹ ë¡œì§
        layers['L0'] = {'name': 'Macro', 'status': 'STABLE', 'desc': 'BTC 1.3ì–µ ì§€ì§€ ì¤‘'}
        
        # L1: Liquidity (ê±°ë˜ëŒ€ê¸ˆ)
        if vol > 100000000000: layers['L1'] = {'status': 'GOOD', 'desc': f'ê±°ë˜ëŒ€ê¸ˆ {vol/100000000:,.0f}ì–µ (í’ë¶€)'}
        else: layers['L1'] = {'status': 'BAD', 'desc': f'ê±°ë˜ëŒ€ê¸ˆ {vol/100000000:,.0f}ì–µ (ë¶€ì¡±)'}
        
        # L2: Technical (ë³€ë™ì„±)
        if chg > 5.0: layers['L2'] = {'status': 'GOOD', 'desc': f'ê°•í•œ ìƒìŠ¹ì„¸ (+{chg:.2f}%)'}
        elif chg < -3.0: layers['L2'] = {'status': 'WATCH', 'desc': f'ê³¼ë§¤ë„ ëˆŒë¦¼ (+{chg:.2f}%)'}
        else: layers['L2'] = {'status': 'NEUTRAL', 'desc': f'íš¡ë³´ êµ¬ê°„ (+{chg:.2f}%)'}
        
        # L5: News
        if news['critical']: layers['L5'] = {'status': 'CRITICAL', 'desc': f"ğŸš¨ ê¸´ê¸‰: {news['title']}"}
        else: layers['L5'] = {'status': 'NEUTRAL', 'desc': 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ'}
        
        # L9: Risk (Kimp)
        if kimp > 4.0: layers['L9'] = {'status': 'DANGER', 'desc': f'ê¹€í”„ ê³¼ì—´ ({kimp:.2f}%)'}
        elif kimp < 0.0: layers['L9'] = {'status': 'OPPORTUNITY', 'desc': f'ì—­í”„ ë°œìƒ ({kimp:.2f}%)'}
        else: layers['L9'] = {'status': 'STABLE', 'desc': f'ê¹€í”„ ì ì • ({kimp:.2f}%)'}
        
        # ë‚˜ë¨¸ì§€ ë ˆì´ì–´ (Simulated for Full View)
        layers['L3'] = {'name': 'Execution', 'status': 'READY', 'desc': 'ì²´ê²°ê°•ë„ 100% ì´ìƒ'}
        layers['L4'] = {'name': 'On-chain', 'status': 'NEUTRAL', 'desc': 'ê³ ë˜ ì§€ê°‘ ì´ë™ ì—†ìŒ'}
        layers['L6'] = {'name': 'Economy', 'status': 'GOOD', 'desc': 'ë‚˜ìŠ¤ë‹¥ ì»¤í”Œë§ ì–‘í˜¸'}
        layers['L7'] = {'name': 'Regulation', 'status': 'BAD', 'desc': 'êµ­ë‚´ ê·œì œ ì´ìŠˆ ì”ì¡´'}
        layers['L8'] = {'name': 'Psychology', 'status': 'GREED', 'desc': 'íƒìš• êµ¬ê°„ (65)'}

        return layers

# [3. UI]
def main():
    hq = Data_HQ()
    engine = Layer_Engine()

    # ìƒë‹¨ë°”
    c1, c2 = st.columns([1, 2])
    ex = c1.selectbox("", ["Upbit", "Bithumb"], label_visibility="collapsed")
    sym = c2.selectbox("", ["KRW-BTC", "KRW-ETH", "KRW-XRP", "KRW-SXP", "KRW-DOGE"], label_visibility="collapsed")

    # ë°ì´í„° ë¡œë“œ
    price, chg, vol = hq.get_market_data(ex, sym)
    kimp, global_p = hq.get_kimp(price, sym)
    news = hq.get_news()
    
    # ë¶„ì„
    L = engine.analyze(price, chg, vol, kimp, news)

    # [TAB 1] ì‚¬ë ¹ê´€ (ìš”ì•½)
    tab1, tab2 = st.tabs(["ğŸ«¡ COMMANDER", "ğŸ§  NICE LAYERS"])
    
    with tab1:
        # ì‚¬ë ¹ê´€ ë©”ì‹œì§€ ë¡œì§
        msg, color = "HOLD / WAIT", "#555"
        if L['L5']['status'] == 'CRITICAL': msg, color = "STRONG BUY", "#ff5252"
        elif L['L9']['status'] == 'DANGER': msg, color = "DO NOT BUY", "#ff5252"
        elif L['L2']['status'] == 'GOOD': msg, color = "RIDE TREND", "#00e676"
        
        st.markdown(f"""
            <div style="background:{color}; padding:20px; border-radius:15px; text-align:center; color:white;">
                <div style="font-size:12px;">COMMANDER ORDER</div>
                <div style="font-size:32px; font-weight:900;">{msg}</div>
            </div>
        """, unsafe_allow_html=True)
        
        c_1, c_2 = st.columns(2)
        c_1.metric(ex, f"{price:,.0f}", f"{chg:.2f}%")
        c_2.metric("Kimchi", f"{kimp:.2f}%", L['L9']['status'])

        # ì‹¤í–‰ ë²„íŠ¼
        if st.button("âš¡ ì‹œì¥ê°€ ë§¤ìˆ˜ (ì¦‰ì‹œ ì‹¤í–‰)", use_container_width=True):
            st.toast("ì£¼ë¬¸ ì „ì†¡ ì™„ë£Œ!", icon="ğŸš€")

    # [TAB 2] ë ˆì´ì–´ ìƒì„¸ ë¶„ì„ (Full View)
    with tab2:
        st.caption(f"NICE Model v45.0 Analysis ({datetime.now().strftime('%H:%M:%S')})")
        
        # ë ˆì´ì–´ ë Œë”ë§ í•¨ìˆ˜
        def draw_layer(idx, name, data):
            style = "l-neu"
            if data['status'] in ['GOOD', 'OPPORTUNITY', 'STABLE', 'READY']: style = "l-pass"
            elif data['status'] in ['BAD', 'DANGER', 'CRITICAL']: style = "l-fail"
            
            icon = "âœ…" if style == "l-pass" else "âš ï¸" if style == "l-fail" else "â–"
            
            st.markdown(f"""
                <div class="layer-box {style}">
                    <div style="font-weight:bold; font-size:14px;">{icon} Layer {idx}: {name}</div>
                    <div style="font-size:12px; opacity:0.8;">ìƒíƒœ: {data['status']} | {data['desc']}</div>
                </div>
            """, unsafe_allow_html=True)

        # 0~9 ë ˆì´ì–´ ìˆœì°¨ ì¶œë ¥
        draw_layer(0, "Macro Trend", L['L0'])
        draw_layer(1, "Liquidity", L['L1'])
        draw_layer(2, "Technical", L['L2'])
        draw_layer(3, "Execution", L['L3'])
        draw_layer(4, "On-chain", L['L4'])
        draw_layer(5, "News & Event", L['L5'])
        draw_layer(6, "Economy", L['L6'])
        draw_layer(7, "Regulation", L['L7'])
        draw_layer(8, "Psychology", L['L8'])
        draw_layer(9, "Risk Mgmt", L['L9'])

    time.sleep(3)
    st.rerun()

if __name__ == "__main__":
    main()
<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>NICE v4 PRO | DASHBOARD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@400;600;800&family=Noto+Sans+KR:wght@400;700&display=swap"
    rel="stylesheet">
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root {
      --bg-body: #111116;
      --bg-panel: #18181f;
      --bg-header: #0b0b0e;
      --accent-purple: #9d00ff;
      --accent-yellow: #ffcc00;
      --accent-blue: #00f0ff;
      --accent-green: #00ff9d;
      --accent-red: #ff0055;
      --border: 1px solid rgba(255, 255, 255, 0.08);
      --font-kr: 'Noto Sans KR', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg-body);
      color: #eee;
      font-family: var(--font-kr);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* HEADER STRIP */
    header {
      flex-shrink: 0;
      padding: 10px 16px;
      background: var(--bg-header);
      border-bottom: var(--border);
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logo {
      font-family: var(--font-mono);
      font-weight: 800;
      font-size: 18px;
      color: #fff;
    }

    .badge {
      background: var(--accent-green);
      color: #000;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 700;
      font-size: 11px;
    }

    .score {
      color: var(--accent-green);
      font-weight: 700;
      font-family: var(--font-mono);
    }

    .search-bar {
      flex: 1;
      max-width: 400px;
      background: #222;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      color: #eee;
      font-family: var(--font-kr);
    }

    .top-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 80px;
    }

    .stat-label {
      font-size: 10px;
      color: #888;
    }

    .stat-val {
      font-size: 12px;
      font-weight: 700;
      color: var(--accent-green);
      font-family: var(--font-mono);
    }

    /* MAIN GRID */
    #main {
      flex: 1;
      display: grid;
      grid-template-columns: 3fr 1fr;
      grid-template-rows: 1fr 280px;
      gap: 12px;
      padding: 12px;
      overflow: hidden;
    }

    /* 1. CHART AREA */
    #chart-container {
      grid-column: 1 / 2;
      grid-row: 1 / 2;
      background: var(--bg-panel);
      border-radius: 12px;
      border: var(--border);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .chart-ctrl {
      padding: 8px 16px;
      border-bottom: var(--border);
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 700;
    }

    #chart-canvas {
      flex: 1;
    }

    /* 2. MARKET MAP (SIDEBAR) */
    #sidebar {
      grid-column: 2 / 3;
      grid-row: 1 / 3;
      background: var(--bg-panel);
      border-radius: 12px;
      border: var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .side-head {
      padding: 12px;
      border-bottom: var(--border);
      font-weight: 700;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .rank-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .rank-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      cursor: pointer;
      font-size: 13px;
    }

    .rank-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
    }

    .rank-sym {
      font-weight: 700;
    }

    .rank-chg {
      font-family: var(--font-mono);
    }

    /* 3. ANALYSIS DECK (BOTTOM) */
    #deck {
      grid-column: 1 / 2;
      grid-row: 2 / 3;
      display: grid;
      grid-template-columns: repeat(3, 1fr) 2fr;
      gap: 12px;
    }

    .card {
      background: var(--bg-panel);
      border-radius: 12px;
      border: var(--border);
      padding: 16px;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .card h3 {
      margin: 0 0 10px 0;
      font-size: 12px;
      color: #aaa;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card h3 i {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    /* THEMES */
    .theme-purple {
      border-left: 3px solid var(--accent-purple);
    }

    .theme-purple i {
      background: var(--accent-purple);
    }

    .theme-yellow {
      border-left: 3px solid var(--accent-yellow);
    }

    .theme-yellow i {
      background: var(--accent-yellow);
    }

    .theme-blue {
      border-left: 3px solid var(--accent-blue);
    }

    .theme-blue i {
      background: var(--accent-blue);
    }

    .theme-dark {
      border: 1px solid var(--accent-blue);
      background: #111;
    }

    /* CARD CONTENTS */
    .big-txt {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .sub-txt {
      font-size: 11px;
      color: #888;
      line-height: 1.4;
    }

    .step-row {
      display: flex;
      gap: 4px;
      margin-top: auto;
    }

    .step {
      width: 20px;
      height: 20px;
      background: #222;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #555;
    }

    .step.active {
      background: var(--accent-purple);
      color: #fff;
    }

    .progress-bg {
      height: 6px;
      background: #333;
      border-radius: 10px;
      margin-top: auto;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      transition: width 1s;
    }

    /* AI BOX */
    .ai-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--accent-blue);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ai-content {
      font-size: 13px;
      color: #ddd;
      line-height: 1.6;
      height: 100%;
      overflow-y: auto;
    }

    /* LOADING */
    #loader {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 99;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--accent-blue);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }
  </style>
</head>

<body>

  <header>
    <div class="logo">NICE<span style="color:#888">PRO</span></div>
    <div class="badge">Type A</div>
    <div class="score">86Ï†ê</div>
    <input type="text" class="search-bar" placeholder="ÏΩîÏù∏ Í≤ÄÏÉâ (BTC, ETH...)" />
    <div style="flex:1"></div>
    <div class="top-stat"><span class="stat-label">Ï∂îÏ≤ú Kelly</span><span class="stat-val">4%</span></div>
    <div class="top-stat"><span class="stat-label">Fear/Greed</span><span class="stat-val"
        style="color:var(--accent-red)">25 Í≥µÌè¨</span></div>
    <div class="top-stat"><span class="stat-label">Net Flow</span><span class="stat-val">+$2.4B</span></div>
    <div style="font-size:10px; color:var(--accent-green)">‚óè LIVE</div>
  </header>

  <div id="main">
    <!-- CHART -->
    <div id="chart-container">
      <div class="chart-ctrl">
        <span id="chart-title">BTC/KRW Loading...</span>
        <div style="display:flex; gap:10px; opacity:0.6;">
          <span>5M</span> <span>15M</span> <span>1H</span> <span>4H</span> <span>1D</span>
        </div>
      </div>
      <div id="chart-canvas"></div>
      <div id="loader">
        <div class="spinner"></div>
        <div style="margin-top:10px; font-size:12px; color:#666">INITIALIZING SYSTEM...</div>
      </div>
    </div>

    <!-- SIDEBAR -->
    <div id="sidebar">
      <div class="side-head">üó∫Ô∏è ÏãúÏû• ÏßÄÎèÑ (Market Map)</div>
      <div class="rank-list" id="rank-list">
        <!-- Items -->
      </div>
    </div>

    <!-- CARDS -->
    <div id="deck">
      <!-- 1. ELLIOTT -->
      <div class="card theme-purple">
        <h3><i></i> Elliott Wave</h3>
        <div class="big-txt" id="ew-title">Î∂ÑÏÑù Ï§ë...</div>
        <div class="sub-txt" id="ew-desc">Îç∞Ïù¥ÌÑ∞ ÏàòÏã† ÎåÄÍ∏∞</div>
        <div class="step-row">
          <div class="step" id="ew-1">1</div>
          <div class="step" id="ew-2">2</div>
          <div class="step active" id="ew-3">3</div>
          <div class="step" id="ew-4">4</div>
          <div class="step" id="ew-5">5</div>
        </div>
      </div>

      <!-- 2. FIBONACCI -->
      <div class="card theme-yellow">
        <h3><i></i> Fibonacci</h3>
        <div class="big-txt" id="fib-title">Î†àÎ≤® Í≥ÑÏÇ∞ Ï§ë</div>
        <div class="sub-txt" style="margin-top:8px;">
          <div style="display:flex; justify-content:space-between"><span>Pivot</span><span id="fib-piv">--</span></div>
          <div style="display:flex; justify-content:space-between; color:var(--accent-yellow)"><span>Support</span><span
              id="fib-sup">--</span></div>
        </div>
        <div class="progress-bg">
          <div class="progress-fill" style="width:50%; background:var(--accent-yellow)"></div>
        </div>
      </div>

      <!-- 3. TREND -->
      <div class="card theme-blue">
        <h3><i></i> Ï∂îÏÑ∏ÏÑ† Î∂ÑÏÑù</h3>
        <div class="big-txt" id="trend-title">Ï∂îÏÑ∏ ÌôïÏù∏ Ï§ë</div>
        <div class="sub-txt">
          <span style="color:var(--accent-green)">‚ñ≤ Ï£ºÏöî Ï†ÄÌï≠</span> <span style="float:right" id="trend-res">--</span><br>
          <span style="color:var(--accent-red)">‚ñº Ï£ºÏöî ÏßÄÏßÄ</span> <span style="float:right" id="trend-sup">--</span>
        </div>
        <div class="progress-bg">
          <div class="progress-fill" id="trend-strength" style="width:0%; background:var(--accent-blue)"></div>
        </div>
        <div style="text-align:right; font-size:10px; color:var(--accent-blue); margin-top:4px;" id="trend-val">0%</div>
      </div>

      <!-- 4. AI -->
      <div class="card theme-dark">
        <div class="ai-title">ü§ñ AI Ìà¨Ïûê Î∂ÑÏÑù <span id="ai-ticker" style="color:#666; margin-left:auto;">--</span></div>
        <div class="ai-content" id="ai-content">
          NICE AI ÏóîÏßÑÏù¥ ÏãúÏû• Îç∞Ïù¥ÌÑ∞Î•º Î∂ÑÏÑùÌïòÍ≥† ÏûàÏäµÎãàÎã§. Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.
        </div>
      </div>
    </div>
  </div>

  <script>
        let chart;
        let candleSeries;
        
        // INIT
        window.onload = async () => {
            initChart();
            await loadMarketMap(); // Load Sidebar
        };

        function initChart() {
            const container = document.getElementById('chart-canvas');
            chart = LightweightCharts.createChart(container, {
                layout: { background: { color: '#18181f' }, textColor: '#888' },
                grid: { vertLines: { color: '#222' }, horzLines: { color: '#222' } },
                width: container.clientWidth,
                height: container.clientHeight
            });
            candleSeries = chart.addCandlestickSeries({
                upColor: '#00ff9d', downColor: '#ff0055',
                wickUpColor: '#00ff9d', wickDownColor: '#ff0055', 
            });
            
            // Resize handler
            new ResizeObserver(entries => {
                const rect = entries[0].contentRect;
                chart.resize(rect.width, rect.height);
            }).observe(container);
        }

        async function loadMarketMap() {
            const list = document.getElementById('rank-list');
            try {
                // Fetch Surge List as default map
                const res = await fetch('/api/screener/surge');
                const data = await res.json();
                
                list.innerHTML = '';
                if(data.list.length > 0) {
                    loadCoin(data.list[0].symbol); // Load top coin
                }
                
                data.list.forEach(c => {
                    const el = document.createElement('div');
                    el.className = 'rank-item';
                    el.onclick = () => loadCoin(c.symbol);
                    el.innerHTML = `
                        <span class="rank-sym">${c.symbol}</span>
                        <span class="rank-chg" style="color:${c.change>=0?'var(--accent-green)':'var(--accent-red)'}">
                            ${c.change}%
                        </span>
                    `;
                    list.appendChild(el);
                });
            } catch(e) { console.error(e); }
        }

        async function loadCoin(ticker) {
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('chart-title').innerText = `${ticker} Loading...`;
            document.getElementById('ai-ticker').innerText = ticker;
            
            try {
                const res = await fetch(`/api/analyze/${ticker}`);
                const data = await res.json();
                
                // 1. UPDATE HEADER METRICS
                const score = data.score || 0;
                document.querySelector('.score').innerText = `${score}Ï†ê`;
                document.querySelector('.badge').innerText = data.type || "Wait";
                document.querySelector('.badge').style.background = score >= 80 ? '#00ff9d' : (score >= 60 ? '#ffcc00' : '#888');
                
                // Kelly
                document.querySelectorAll('.stat-val')[0].innerText = `${data.kelly}%`;
                
                // Update Card Titles
                document.getElementById('chart-title').innerText = `${ticker} / KRW`;
                
                // 2. TECH CARDS
                updateTechCards(data.tech);
                
                // 3. AI TEXT
                if(data.ai) {
                    document.getElementById('ai-content').innerText = 
                        `${data.ai.reasoning}\n\nTarget: ${data.ai.target_price} | Stop: ${data.ai.stop_loss}`;
                } else {
                    document.getElementById('ai-content').innerText = "AI Analysis Unavailable";
                }
                
                // 4. CHART DATA (Mock -> Real would be data.chart)
                // Using mock renderer for visual fidelity check
                renderMockChart(data.tech.price, data.tech.trend);
                
                document.getElementById('loader').style.display = 'none';

            } catch(e) {
                console.error(e);
                document.getElementById('loader').style.display = 'none';
            }
        }

        function updateTechCards(tech) {
            // ELLIOTT: Simulate based on Trend for Demo
            if(tech.trend.includes("UP")) {
                document.getElementById('ew-title').innerText = "Wave 3 ÏÉÅÏäπ";
                document.getElementById('ew-desc').innerText = "5Ìåå ÏÉÅÏäπ Ï§ë 3Ìåå ÏßÑÌñâ (Í∞ïÎ†• Îß§Ïàò Íµ¨Í∞Ñ)";
                setActiveStep(3);
            } else {
                document.getElementById('ew-title').innerText = "Ï°∞Ï†ï ÌååÎèô (Correction)";
                document.getElementById('ew-desc').innerText = "ÌïòÎùΩ Îã§Ïù¥Î≤ÑÏ†ÑÏä§ Ï∂úÌòÑ";
                setActiveStep(4);
            }

            // FIB
            document.getElementById('fib-title').innerText = "61.8% ÏßÄÏßÄ ÌÖåÏä§Ìä∏";
            document.getElementById('fib-piv').innerText = tech.fib['0.382'].toLocaleString();
            document.getElementById('fib-sup').innerText = tech.fib['0.618'].toLocaleString();

            // TREND
            const rsi = tech.rsi;
            document.getElementById('trend-title').innerText = tech.trend.includes("UP") ? "ÏÉÅÏäπ Ï∂îÏÑ∏ Ïú†ÏßÄ" : "ÌïòÎùΩ Î∞òÏ†Ñ Ï£ºÏùò";
            document.getElementById('trend-res').innerText = (tech.price * 1.05).toLocaleString();
            document.getElementById('trend-sup').innerText = (tech.price * 0.95).toLocaleString();
            document.getElementById('trend-strength').style.width = rsi + "%";
            document.getElementById('trend-val').innerText = rsi.toFixed(0) + "%";
        }
        
        function setActiveStep(n) {
            for(let i=1; i<=5; i++) {
                document.getElementById(`ew-${i}`).className = i === n ? 'step active' : 'step';
            }
        }

        function renderMockChart(price, trend) {
            let data = [];
            let curr = price * 0.95;
            let now = Math.floor(Date.now()/1000);
            for(let i=0; i<100; i++) {
                let time = now - (100-i)*3600;
                let chg = (Math.random()-0.5)*(price*0.02);
                if(trend.includes("UP")) chg += price*0.002;
                let close = curr + chg;
                let high = Math.max(curr, close) + price*0.005;
                let low = Math.min(curr, close) - price*0.005;
                data.push({time, open:curr, high, low, close});
                curr = close;
            }
            candleSeries.setData(data);
        }
  </script>
</body>

</html>
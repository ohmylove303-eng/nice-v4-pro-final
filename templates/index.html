<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>NICE v4 PRO | DASHBOARD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Inter:wght@400;600;800&family=Noto+Sans+KR:wght@400;700&display=swap"
    rel="stylesheet">
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    :root {
      --bg-body: #111116;
      --bg-panel: #18181f;
      --bg-header: #0b0b0e;
      --accent-purple: #9d00ff;
      --accent-yellow: #ffcc00;
      --accent-blue: #00f0ff;
      --accent-green: #00ff9d;
      --accent-red: #ff0055;
      --border: 1px solid rgba(255, 255, 255, 0.08);
      --font-kr: 'Noto Sans KR', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg-body);
      color: #eee;
      font-family: var(--font-kr);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    header {
      flex-shrink: 0;
      padding: 10px 16px;
      background: var(--bg-header);
      border-bottom: var(--border);
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logo {
      font-family: var(--font-mono);
      font-weight: 800;
      font-size: 18px;
      color: #fff;
    }

    .badge {
      background: #222;
      color: #888;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 700;
      font-size: 11px;
    }

    .score {
      color: #888;
      font-weight: 700;
      font-family: var(--font-mono);
    }

    .search-bar {
      flex: 1;
      max-width: 400px;
      background: #222;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      color: #eee;
      font-family: var(--font-kr);
    }

    .top-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 80px;
    }

    .stat-label {
      font-size: 10px;
      color: #888;
    }

    .stat-val {
      font-size: 12px;
      font-weight: 700;
      color: #888;
      font-family: var(--font-mono);
    }

    #main {
      flex: 1;
      display: grid;
      grid-template-columns: 3fr 1fr;
      grid-template-rows: 1fr 280px;
      gap: 12px;
      padding: 12px;
      overflow: hidden;
    }

    #chart-container {
      grid-column: 1 / 2;
      grid-row: 1 / 2;
      background: var(--bg-panel);
      border-radius: 12px;
      border: var(--border);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .chart-ctrl {
      padding: 8px 16px;
      border-bottom: var(--border);
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 700;
    }

    #chart-canvas {
      flex: 1;
    }

    #sidebar {
      grid-column: 2 / 3;
      grid-row: 1 / 3;
      background: var(--bg-panel);
      border-radius: 12px;
      border: var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .side-head {
      padding: 12px;
      border-bottom: var(--border);
      font-weight: 700;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .side-head:hover {
      color: var(--accent-blue);
    }

    .rank-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .rank-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      cursor: pointer;
      font-size: 13px;
    }

    .rank-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
    }

    #deck {
      grid-column: 1 / 2;
      grid-row: 2 / 3;
      display: grid;
      grid-template-columns: repeat(3, 1fr) 2fr;
      gap: 12px;
    }

    .card {
      background: var(--bg-panel);
      border-radius: 12px;
      border: var(--border);
      padding: 16px;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .card h3 {
      margin: 0 0 10px 0;
      font-size: 12px;
      color: #aaa;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card h3 i {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .theme-purple {
      border-left: 3px solid var(--accent-purple);
    }

    .theme-purple i {
      background: var(--accent-purple);
    }

    .theme-yellow {
      border-left: 3px solid var(--accent-yellow);
    }

    .theme-yellow i {
      background: var(--accent-yellow);
    }

    .theme-blue {
      border-left: 3px solid var(--accent-blue);
    }

    .theme-blue i {
      background: var(--accent-blue);
    }

    .theme-dark {
      border: 1px solid var(--accent-blue);
      background: #111;
    }

    .big-txt {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .sub-txt {
      font-size: 11px;
      color: #888;
      line-height: 1.4;
    }

    .step-row {
      display: flex;
      gap: 4px;
      margin-top: auto;
    }

    .step {
      width: 20px;
      height: 20px;
      background: #222;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #555;
    }

    .step.active {
      background: var(--accent-purple);
      color: #fff;
    }

    .progress-bg {
      height: 6px;
      background: #333;
      border-radius: 10px;
      margin-top: auto;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      transition: width 1s;
    }

    #loader {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 99;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      display: none;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--accent-blue);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }
  </style>
</head>

<body>

  <header>
    <div class="logo">NICE<span style="color:#888">PRO</span></div>
    <div class="badge" id="app-badge">--</div>
    <div class="score" id="app-score">--</div>
    <input type="text" class="search-bar" id="search-input" placeholder="ÏΩîÏù∏ Í≤ÄÏÉâ (Ïòà: BTC, SOL...)" />
    <div style="flex:1"></div>
    <div class="top-stat"><span class="stat-label">Ï∂îÏ≤ú Kelly</span><span class="stat-val" id="app-kelly">--</span></div>
    <div class="top-stat"><span class="stat-label">Fear/Greed</span><span class="stat-val"
        style="color:var(--accent-red)">25 Í≥µÌè¨</span></div>
    <div class="top-stat"><span class="stat-label">Net Flow</span><span class="stat-val">+$2.4B</span></div>
    <div style="font-size:10px; color:var(--accent-green)">‚óè LIVE</div>
  </header>

  <div id="main">
    <div id="chart-container">
      <div class="chart-ctrl">
        <span id="chart-title">MARKET READY</span>
        <div style="display:flex; gap:10px; opacity:0.6;"><span>5M</span> <span>15M</span> <span>1H</span>
          <span>4H</span> <span>1D</span></div>
      </div>
      <div id="chart-canvas"></div>
      <div id="loader">
        <div class="spinner"></div>
        <div style="margin-top:10px; font-size:12px; color:#666">ANALYZING...</div>
      </div>
    </div>

    <div id="sidebar">
      <div class="side-head" onclick="loadList('surge')">‚ö° Í∏âÎì± (Surge)</div>
      <div class="side-head" onclick="loadList('majors')">üíé Î©îÏù¥Ï†Ä (Major)</div>
      <div class="side-head" onclick="loadList('scalping')">üéØ Ïä§Ï∫òÌïë (Scalp)</div>
      <div class="rank-list" id="rank-list"></div>
    </div>

    <div id="deck">
      <!-- ELLIOTT -->
      <div class="card theme-purple">
        <h3><i></i> Elliott Wave</h3>
        <div class="big-txt" id="ew-title">--</div>
        <div class="sub-txt" id="ew-desc">ÎåÄÍ∏∞ Ï§ë...</div>
        <div class="step-row">
          <div class="step" id="ew-1">1</div>
          <div class="step" id="ew-2">2</div>
          <div class="step" id="ew-3">3</div>
          <div class="step" id="ew-4">4</div>
          <div class="step" id="ew-5">5</div>
        </div>
      </div>
      <!-- FIBONACCI -->
      <div class="card theme-yellow">
        <h3><i></i> Fibonacci</h3>
        <div class="big-txt" id="fib-title">--</div>
        <div class="sub-txt" style="margin-top:8px;">
          <div style="display:flex; justify-content:space-between"><span>Pivot</span><span id="fib-piv">--</span></div>
          <div style="display:flex; justify-content:space-between; color:var(--accent-yellow)"><span>Support</span><span
              id="fib-sup">--</span></div>
        </div>
        <div class="progress-bg">
          <div class="progress-fill" style="width:50%; background:var(--accent-yellow)"></div>
        </div>
      </div>
      <!-- TREND -->
      <div class="card theme-blue">
        <h3><i></i> Ï∂îÏÑ∏ÏÑ† Î∂ÑÏÑù</h3>
        <div class="big-txt" id="trend-title">--</div>
        <div class="sub-txt">
          <span style="color:var(--accent-green)">‚ñ≤ Ï†ÄÌï≠</span> <span style="float:right" id="trend-res">--</span><br>
          <span style="color:var(--accent-red)">‚ñº ÏßÄÏßÄ</span> <span style="float:right" id="trend-sup">--</span>
        </div>
        <div class="progress-bg">
          <div class="progress-fill" id="trend-strength" style="width:0%; background:var(--accent-blue)"></div>
        </div>
        <div style="text-align:right; font-size:10px; color:var(--accent-blue); margin-top:4px;" id="trend-val">0%</div>
      </div>
      <!-- AI -->
      <div class="card theme-dark">
        <div class="ai-title" style="color:var(--accent-blue); font-weight:700; font-size:12px; margin-bottom:8px;">ü§ñ
          AI Ìà¨Ïûê Î∂ÑÏÑù</div>
        <div class="ai-content" id="ai-content" style="font-size:13px; color:#ddd; line-height:1.6;">Î¶¨Ïä§Ìä∏ÏóêÏÑú ÏΩîÏù∏ÏùÑ ÏÑ†ÌÉùÌïòÍ±∞ÎÇò
          Í≤ÄÏÉâÌïòÏÑ∏Ïöî.</div>
      </div>
    </div>
  </div>

  <script>
        let chart, candleSeries;
        
        window.onload = async () => {
            initChart();
            await loadList('majors'); // Default to Majors
            loadCoin('BTC'); // Default Coin
            
            // Search Input Binding
            document.getElementById('search-input').addEventListener('keydown', (e) => {
                if(e.key === 'Enter') {
                    loadCoin(e.target.value.toUpperCase());
                }
            });
        };

        function initChart() {
            const container = document.getElementById('chart-canvas');
            chart = LightweightCharts.createChart(container, {
                layout: { background: { color: '#18181f' }, textColor: '#888' },
                grid: { vertLines: { color: '#222' }, horzLines: { color: '#222' } },
            });
            candleSeries = chart.addCandlestickSeries({ upColor: '#00ff9d', downColor: '#ff0055' });
            new ResizeObserver(e => chart.resize(e[0].contentRect.width, e[0].contentRect.height)).observe(container);
        }

        async function loadList(cat) {
            const list = document.getElementById('rank-list');
            list.innerHTML = '<div style="padding:10px; font-size:12px; color:#666">Loading...</div>';
            try {
                const res = await fetch(`/api/screener/${cat}`);
                const data = await res.json();
                list.innerHTML = '';
                data.list.forEach(c => {
                    const el = document.createElement('div');
                    el.className = 'rank-item';
                    el.innerHTML = `<span style="font-weight:700">${c.symbol}</span><span style="font-family:'JetBrains Mono'; color:${c.change>=0?'var(--accent-green)':'var(--accent-red)'}">${c.change}%</span>`;
                    el.onclick = () => loadCoin(c.symbol);
                    list.appendChild(el);
                });
            } catch(e) { list.innerHTML = "Error"; }
        }

        async function loadCoin(ticker) {
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('chart-title').innerText = `${ticker} Loading...`;
            
            try {
                const res = await fetch(`/api/analyze/${ticker}`);
                const data = await res.json();
                if(data.error) throw new Error(data.error);
                
                // HEADER
                document.getElementById('app-score').innerText = `${data.score}Ï†ê`;
                document.getElementById('app-badge').innerText = data.type;
                const score = data.score;
                document.getElementById('app-badge').style.background = score >= 80 ? '#00ff9d' : (score >= 60 ? '#ffcc00' : '#444');
                document.getElementById('app-badge').style.color = score >= 80 ? '#000' : (score >= 60 ? '#000' : '#fff');
                document.getElementById('app-kelly').innerText = `${data.kelly}%`;
                
                // CARDS
                // 1. Elliott
                document.getElementById('ew-title').innerText = data.tech.trend;
                document.querySelectorAll('.step').forEach(s=>s.classList.remove('active'));
                if(data.tech.trend.includes("Wave 3")) document.getElementById('ew-3').classList.add('active');
                else if(data.tech.trend.includes("Correction")) document.getElementById('ew-4').classList.add('active');
                else document.getElementById('ew-1').classList.add('active');
                
                // 2. Fib
                const p = data.tech.price;
                const fib = data.tech.fib;
                document.getElementById('fib-title').innerText = p > fib['0.618'] ? "ÏßÄÏßÄ ÌÖåÏä§Ìä∏ (0.618)" : "Ï†ÄÌï≠ ÎèåÌåå ÏãúÎèÑ";
                document.getElementById('fib-piv').innerText = fib['0.5'].toLocaleString();
                document.getElementById('fib-sup').innerText = fib['0.618'].toLocaleString();
                
                // 3. Trend
                document.getElementById('trend-title').innerText = score > 50 ? "ÏÉÅÏäπ Ïö∞ÏúÑ" : "ÌïòÎùΩ Ïö∞ÏúÑ";
                document.getElementById('trend-res').innerText = (p*1.05).toLocaleString();
                document.getElementById('trend-sup').innerText = (p*0.95).toLocaleString();
                document.getElementById('trend-strength').style.width = `${data.tech.rsi}%`;
                document.getElementById('trend-val').innerText = `${data.tech.rsi.toFixed(1)}%`;
                
                // 4. AI
                document.getElementById('ai-content').innerText = data.ai.reasoning;
                document.getElementById('chart-title').innerText = `${ticker} / KRW`;
                
                // MOCK CHART DATA FOR VISUAL (In real app, fetch candles)
                renderMockChart(p, score > 50);
                
                document.getElementById('loader').style.display = 'none';
            } catch(e) {
                alert(e.message);
                document.getElementById('loader').style.display = 'none';
            }
        }
        
        function renderMockChart(price, isUp) {
            let d = [];
            let c = price;
            let now = Math.floor(Date.now()/1000);
            for(let i=100; i>0; i--) {
                const time = now - i*3600;
                const chg = (Math.random()-0.5)*(price*0.02) + (isUp ? price*0.001 : -price*0.001);
                const close = c + chg;
                d.push({time, open:c, high:Math.max(c,close)+price*0.01, low:Math.min(c,close)-price*0.01, close});
                c = close;
            }
            candleSeries.setData(d);
        }
  </script>
</body>

</html>
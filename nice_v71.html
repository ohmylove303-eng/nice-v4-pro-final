<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NICE-M v71 - ÏôÑÏ†Ñ ÌÜµÌï© Ìä∏Î†àÏù¥Îî© ÏãúÏä§ÌÖú</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: 'Segoe UI', 'Noto Sans KR', sans-serif;
        }
        body {
            background: #0a0e27;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #00e676;
            padding-bottom: 15px;
        }
        .header h1 {
            font-size: 32px;
            color: #00e676;
            margin-bottom: 5px;
        }
        .header p {
            color: #888;
            font-size: 14px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .control-panel {
            background: #1a1e3f;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .price-display {
            font-size: 42px;
            font-weight: bold;
            color: #00e676;
            text-align: center;
            background: linear-gradient(135deg, #1a1e3f, #2a2e4f);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #00e676;
            box-shadow: 0 0 20px rgba(0,230,118,0.3);
            margin: 20px 0;
        }
        .wrs-box {
            background: linear-gradient(135deg, #1a237e, #283593);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #3949ab;
            text-align: center;
            margin: 20px 0;
            color: #fff;
        }
        .wrs-score {
            font-size: 56px;
            font-weight: bold;
            color: #00e676;
            margin: 10px 0;
        }
        .cmd-box {
            padding: 20px;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
            font-size: 18px;
            margin: 20px 0;
        }
        .cmd-buy {
            background: linear-gradient(135deg, #00c853, #009624);
            color: white;
            box-shadow: 0 4px 15px rgba(0,200,83,0.4);
        }
        .cmd-sell {
            background: linear-gradient(135deg, #ff5252, #d32f2f);
            color: white;
            box-shadow: 0 4px 15px rgba(255,82,82,0.4);
        }
        .cmd-wait {
            background: #212529;
            color: #aaa;
            border: 2px dashed #555;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            border-bottom: 1px solid #333;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 10px 20px;
            background: #1a1e3f;
            border: none;
            color: #888;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .tab-btn.active {
            color: #00e676;
            border-bottom-color: #00e676;
            background: #2a2e4f;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .metric-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .metric-card {
            background: #2c3035;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #444;
        }
        .metric-val {
            font-size: 24px;
            font-weight: bold;
            color: #00e676;
        }
        .metric-lab {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        .layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .layer-card {
            background: #2c3035;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #555;
        }
        .layer-pass {
            border-left-color: #00e676;
        }
        .layer-fail {
            border-left-color: #ff5252;
        }
        .layer-neu {
            border-left-color: #aaa;
        }
        .layer-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .layer-score {
            font-size: 24px;
            font-weight: bold;
            margin: 8px 0;
        }
        .layer-desc {
            font-size: 12px;
            color: #888;
            word-break: break-word;
        }
        .plan-table {
            width: 100%;
            background: #2c3035;
            border-radius: 8px;
            overflow: hidden;
            margin: 15px 0;
        }
        .plan-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            border-bottom: 1px solid #444;
        }
        .plan-row:last-child {
            border-bottom: none;
        }
        .plan-label {
            background: #1a1e3f;
            padding: 12px;
            font-weight: bold;
            border-right: 1px solid #444;
        }
        .plan-value {
            padding: 12px;
            text-align: right;
            font-size: 16px;
            font-weight: bold;
            color: #00e676;
        }
        .log-table {
            width: 100%;
            background: #2c3035;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
            margin: 15px 0;
            font-size: 13px;
        }
        .log-table th {
            background: #1a1e3f;
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #444;
            font-weight: bold;
        }
        .log-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #444;
        }
        .log-table tr:hover {
            background: #3c4045;
        }
        .btn {
            padding: 10px 20px;
            background: #00e676;
            color: #000;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn:hover {
            background: #00d66f;
            transform: translateY(-2px);
        }
        .info-box {
            background: #1a1e3f;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #00e676;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíé NICE-M v71 System</h1>
            <p>ÏôÑÏ†Ñ ÌÜµÌï© Îã§Ï∏µ Ìä∏Î†àÏù¥Îî© ÏóîÏßÑ + ÏûêÎèô Î°úÍπÖ + WRS Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Í¥ÄÎ¶¨</p>
        </div>

        <div class="control-panel">
            <label>ÏΩîÏù∏ ÏÑ†ÌÉù:</label>
            <select id="coinSelect" style="padding:8px; border-radius:4px; background:#2c3035; color:#00e676; border:1px solid #444; cursor:pointer;">
                <option value="BTC">üëë KRW-BTC</option>
                <option value="ETH">üëë KRW-ETH</option>
                <option value="SOL">üìä KRW-SOL</option>
                <option value="XRP">üìä KRW-XRP</option>
            </select>
            <button class="btn" onclick="updateAnalysis()">Î∂ÑÏÑù Ïã§Ìñâ</button>
            <button class="btn" onclick="downloadLog()">üì• Î°úÍ∑∏ Îã§Ïö¥Î°úÎìú</button>
        </div>

        <div class="price-display" id="priceDisplay">Î°úÎî© Ï§ë...</div>

        <div class="wrs-box">
            <div style="font-size:14px; opacity:0.7; margin-bottom:10px;">COMPOSITE WRS SCORE</div>
            <div class="wrs-score" id="wrsScore">-</div>
            <div style="font-size:12px; margin-top:10px; opacity:0.8;">Signal: <span id="wrsSignal">-</span></div>
        </div>

        <div class="cmd-box" id="cmdBox">
            ÎåÄÍ∏∞ Ï§ë...
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('metrics')">üìä Metrics</button>
            <button class="tab-btn" onclick="switchTab('layers')">üß† Layers</button>
            <button class="tab-btn" onclick="switchTab('chart')">üìà Chart</button>
            <button class="tab-btn" onclick="switchTab('plan')">üíº Plan</button>
            <button class="tab-btn" onclick="switchTab('log')">üìù Log</button>
        </div>

        <div id="metrics" class="tab-content active">
            <div class="metric-row">
                <div class="metric-card">
                    <div class="metric-lab">1H Change</div>
                    <div class="metric-val" id="chg1h">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-lab">12H Change</div>
                    <div class="metric-val" id="chg12h">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-lab">RSI(14)</div>
                    <div class="metric-val" id="rsi">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-lab">Volume Ratio</div>
                    <div class="metric-val" id="volRatio">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-lab">24H Volume</div>
                    <div class="metric-val" id="vol24h">-</div>
                </div>
            </div>
        </div>

        <div id="layers" class="tab-content">
            <div class="layer-grid" id="layerGrid"></div>
        </div>

        <div id="chart" class="tab-content">
            <div id="chartDiv" style="height:400px; background:#1a1e3f; border-radius:8px; border:1px solid #444;"></div>
        </div>

        <div id="plan" class="tab-content">
            <div class="plan-table">
                <div class="plan-row">
                    <div class="plan-label">üîµ Buy 1 (ÏßÑÏûÖ)</div>
                    <div class="plan-value" id="buy1">-</div>
                </div>
                <div class="plan-row">
                    <div class="plan-label">üü¢ Buy 2 (Ï∂îÍ∞Ä)</div>
                    <div class="plan-value" id="buy2">-</div>
                </div>
                <div class="plan-row">
                    <div class="plan-label">‚õî Stop Loss</div>
                    <div class="plan-value" id="stop">-</div>
                </div>
                <div class="plan-row">
                    <div class="plan-label">üìà Sell 1 (ÏùºÎ∂Ä)</div>
                    <div class="plan-value" id="sell1">-</div>
                </div>
                <div class="plan-row">
                    <div class="plan-label">üî¥ Sell 2 (Ï†ÑÎüâ)</div>
                    <div class="plan-value" id="sell2">-</div>
                </div>
            </div>
            <div class="info-box">
                <strong>Ìè¨ÏßÄÏÖò Í¥ÄÎ¶¨ Í∑úÏπô:</strong><br>
                ‚Ä¢ ÏßÑÏûÖ: Buy 1 ‚Üí Buy 2 (Î∂ÑÌï† ÏßÑÏûÖ)<br>
                ‚Ä¢ ÏùµÏ†à: Sell 1 (50%) ‚Üí Sell 2 (ÎÇòÎ®∏ÏßÄ)<br>
                ‚Ä¢ ÏÜêÏ†à: Í∞ÄÍ≤©Ïù¥ Stop Loss ÎèÑÎã¨ Ïãú Ï¶âÏãú Ï≤≠ÏÇ∞
            </div>
        </div>

        <div id="log" class="tab-content">
            <div style="margin-bottom:10px;">
                <strong>Ïã§ÏãúÍ∞Ñ ÏÑ∏ÏÖò Î°úÍ∑∏</strong> (ÏµúÍ∑º 20Í∞ú)
            </div>
            <table class="log-table">
                <thead>
                    <tr>
                        <th>ÏãúÍ∞Ñ</th>
                        <th>WRS</th>
                        <th>Command</th>
                        <th>ÏΩîÏù∏</th>
                        <th>L0~L9</th>
                    </tr>
                </thead>
                <tbody id="logBody">
                    <tr>
                        <td colspan="5" style="text-align:center; color:#888;">Î°úÍ∑∏ Í∏∞Î°ù Ï§ë...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let sessionLog = JSON.parse(localStorage.getItem('niceLog')) || [];
        
        async function updateAnalysis() {
            const coin = document.getElementById('coinSelect').value;
            const sym = `KRW-${coin}`;
            
            try {
                // 1. ÏãúÏÑ∏ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
                const tickerRes = await fetch(`https://api.upbit.com/v1/ticker?markets=${sym}`);
                const ticker = (await tickerRes.json())[0];
                const price = parseFloat(ticker.trade_price);
                const vol24h = parseFloat(ticker.acc_trade_price_24h);
                
                // 2. 1ÏãúÍ∞Ñ Ï∫îÎì§
                const c1hRes = await fetch(`https://api.upbit.com/v1/candles/minutes/60?market=${sym}&count=24`);
                const c1hData = (await c1hRes.json()).reverse();
                
                // 3. ÏùºÍ∞Ñ Ï∫îÎì§
                const cdRes = await fetch(`https://api.upbit.com/v1/candles/days?market=${sym}&count=30`);
                const cdData = (await cdRes.json());
                
                // 4. Í∏∞Ïà†Ï†Å ÏßÄÌëú Í≥ÑÏÇ∞
                const rsi = calcRSI(c1hData.map(c => c.trade_price));
                const chg1h = ((price - c1hData[1].trade_price) / c1hData[1].trade_price) * 100;
                const chg12h = ((price - c1hData[12].trade_price) / c1hData[12].trade_price) * 100;
                const volRatio = (c1hData[0].candle_acc_trade_volume / 
                    (c1hData.slice(1, 11).reduce((a, c) => a + c.candle_acc_trade_volume, 0) / 10)) * 100;
                
                // 5. L0~L9 Í≥ÑÏÇ∞
                const layers = {
                    'L0': calcL0(chg12h, chg1h),
                    'L1': calcL1(vol24h, volRatio),
                    'L2': calcL2(rsi, chg1h),
                    'L3': calcL3(volRatio, chg1h),
                    'L4': calcL4(),
                    'L5': calcL5(false),
                    'L6': calcL6(),
                    'L7': calcL7(),
                    'L8': calcL8(rsi),
                    'L9': calcL9(0.0, volRatio > 200)
                };
                
                const wrs = calcWRS(layers);
                const cmd = generateCmd(wrs, layers);
                
                // 6. UI ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('priceDisplay').textContent = `${sym}: ‚Ç©${price.toLocaleString('ko-KR', {maximumFractionDigits: 0})}`;
                document.getElementById('wrsScore').textContent = wrs;
                document.getElementById('wrsSignal').textContent = wrs > 70 ? 'üü¢ STRONG' : wrs > 50 ? 'üü° NORMAL' : 'üî¥ WEAK';
                
                const cmdBox = document.getElementById('cmdBox');
                cmdBox.textContent = cmd;
                cmdBox.className = 'cmd-box ' + (cmd.includes('BUY') ? 'cmd-buy' : cmd.includes('HALT') ? 'cmd-sell' : 'cmd-wait');
                
                document.getElementById('chg1h').textContent = chg1h.toFixed(2) + '%';
                document.getElementById('chg12h').textContent = chg12h.toFixed(2) + '%';
                document.getElementById('rsi').textContent = rsi.toFixed(1);
                document.getElementById('volRatio').textContent = volRatio.toFixed(0) + '%';
                document.getElementById('vol24h').textContent = '‚Ç©' + (vol24h / 100000000).toFixed(0) + 'Ïñµ';
                
                // 7. Î†àÏù¥Ïñ¥ Ïπ¥Îìú
                const layerGrid = document.getElementById('layerGrid');
                layerGrid.innerHTML = '';
                for (const [lName, lData] of Object.entries(layers)) {
                    const statusClass = lData.score > 70 ? 'layer-pass' : lData.score < 50 ? 'layer-fail' : 'layer-neu';
                    layerGrid.innerHTML += `
                        <div class="layer-card ${statusClass}">
                            <div class="layer-name">${lName}</div>
                            <div class="layer-score">${lData.score}</div>
                            <div class="layer-desc">${lData.desc}</div>
                        </div>
                    `;
                }
                
                // 8. ÏßÑÏûÖ/ÏùµÏ†à Í≥ÑÌöç
                const gap = price * 0.015;
                document.getElementById('buy1').textContent = '‚Ç©' + price.toLocaleString('ko-KR', {maximumFractionDigits: 0});
                document.getElementById('buy2').textContent = '‚Ç©' + (price - gap).toLocaleString('ko-KR', {maximumFractionDigits: 0});
                document.getElementById('stop').textContent = '‚Ç©' + (price - gap * 2.5).toLocaleString('ko-KR', {maximumFractionDigits: 0});
                document.getElementById('sell1').textContent = '‚Ç©' + (price + gap).toLocaleString('ko-KR', {maximumFractionDigits: 0});
                document.getElementById('sell2').textContent = '‚Ç©' + (price + gap * 2.5).toLocaleString('ko-KR', {maximumFractionDigits: 0});
                
                // 9. Ï∞®Ìä∏ Í∑∏Î¶¨Í∏∞
                drawChart(c1hData, sym);
                
                // 10. Î°úÍ∑∏ Ï∂îÍ∞Ä
                const snapshot = {
                    timestamp: new Date().toLocaleString('ko-KR'),
                    wrs: wrs,
                    cmd: cmd,
                    symbol: sym,
                    layers: Object.fromEntries(Object.entries(layers).map(([k, v]) => [k, v.score]))
                };
                sessionLog.push(snapshot);
                if (sessionLog.length > 100) sessionLog.shift();
                localStorage.setItem('niceLog', JSON.stringify(sessionLog));
                updateLogTable();
                
            } catch (err) {
                console.error('Error:', err);
                alert('Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ïã§Ìå®: ' + err.message);
            }
        }
        
        function calcRSI(prices, period = 14) {
            const deltas = [];
            for (let i = 1; i < prices.length; i++) {
                deltas.push(prices[i] - prices[i - 1]);
            }
            
            let gains = 0, losses = 0;
            for (let i = 0; i < period; i++) {
                gains += deltas[i] > 0 ? deltas[i] : 0;
                losses -= deltas[i] < 0 ? deltas[i] : 0;
            }
            
            const rs = gains / losses;
            return 100 - (100 / (1 + rs));
        }
        
        function calcL0(chg12h, chg1h) {
            if (chg12h > 3.0) return { score: 80, desc: 'Strong uptrend' };
            if (chg12h > 0.5) return { score: 72, desc: 'Weak uptrend' };
            if (chg12h > -1.0) return { score: 65, desc: 'Stabilizing' };
            return { score: 45, desc: 'Downtrend risk' };
        }
        
        function calcL1(vol24h, volRatio) {
            if (vol24h > 50000000000 && volRatio > 100) return { score: 78, desc: 'High volume' };
            if (vol24h > 30000000000) return { score: 70, desc: 'Normal volume' };
            return { score: 55, desc: 'Low volume' };
        }
        
        function calcL2(rsi, chg1h) {
            if (rsi > 70) return { score: 40, desc: `Overbought (RSI ${rsi.toFixed(1)})` };
            if (rsi < 30) return { score: 80, desc: `Oversold signal (RSI ${rsi.toFixed(1)})` };
            if (rsi >= 40 && rsi <= 60 && chg1h > 0) return { score: 75, desc: `Neutral bullish (RSI ${rsi.toFixed(1)})` };
            return { score: 60, desc: `Neutral (RSI ${rsi.toFixed(1)})` };
        }
        
        function calcL3(volRatio, chg1h) {
            if (volRatio > 150 && chg1h > 0.5) return { score: 80, desc: `Strong execution (${volRatio.toFixed(0)}%)` };
            if (volRatio > 100) return { score: 70, desc: 'Normal execution' };
            return { score: 55, desc: `Weak execution (${volRatio.toFixed(0)}%)` };
        }
        
        function calcL4() { return { score: 60, desc: 'On-chain: API pending' }; }
        function calcL5(crit) { return crit ? { score: 90, desc: 'üî• Critical news' } : { score: 65, desc: 'No critical news' }; }
        function calcL6() { return { score: 70, desc: 'End-year liquidity +' }; }
        function calcL7() { return { score: 65, desc: 'Korea medium risk' }; }
        
        function calcL8(rsi) {
            if (rsi < 30) return { score: 85, desc: 'Fear zone (bottom signal)' };
            if (rsi > 70) return { score: 35, desc: 'Greed zone (caution)' };
            return { score: 60, desc: 'Neutral mood' };
        }
        
        function calcL9(kimp, extremeVol) {
            if (kimp > 5.0) return { score: 30, desc: `High KIMP ${kimp.toFixed(2)}%` };
            if (extremeVol) return { score: 35, desc: 'Extreme volatility' };
            return { score: 75, desc: 'Safe' };
        }
        
        function calcWRS(layers) {
            const weights = {
                L0: 0.20, L1: 0.15, L2: 0.20, L3: 0.15,
                L4: 0.10, L5: 0.05, L6: 0.05, L7: 0.03,
                L8: 0.05, L9: 0.02
            };
            
            let wrs = 0;
            for (const [layer, weight] of Object.entries(weights)) {
                wrs += layers[layer].score * weight;
            }
            return Math.round(wrs);
        }
        
        function generateCmd(wrs, layers) {
            if (layers.L9.score < 40) return 'üî¥ RISK HALT';
            if (wrs < 50) return '‚õî WAIT (Low WRS)';
            if (layers.L2.score > 75 && layers.L3.score > 70) return 'üöÄ STRONG BUY';
            if (wrs > 70 && layers.L2.score > 65) return 'üìà BUY';
            if (wrs > 60) return '‚è∏Ô∏è HOLD';
            return 'üü° MONITOR';
        }
        
        function drawChart(candles, sym) {
            const times = candles.map(c => c.candle_date_time_kst);
            const opens = candles.map(c => c.opening_price);
            const highs = candles.map(c => c.high_price);
            const lows = candles.map(c => c.low_price);
            const closes = candles.map(c => c.trade_price);
            
            const trace = {
                x: times,
                open: opens,
                high: highs,
                low: lows,
                close: closes,
                type: 'candlestick',
                increasing: { line: { color: '#00e676' } },
                decreasing: { line: { color: '#ff5252' } }
            };
            
            const layout = {
                title: `${sym} - 1H Candlestick`,
                xaxis: { rangeslider: { visible: false }, color: '#888' },
                yaxis: { color: '#888' },
                plot_bgcolor: '#1a1e3f',
                paper_bgcolor: '#0a0e27',
                font: { color: '#e0e0e0' },
                margin: { l: 60, r: 20, t: 40, b: 40 }
            };
            
            Plotly.newPlot('chartDiv', [trace], layout, { responsive: true });
        }
        
        function updateLogTable() {
            const tbody = document.getElementById('logBody');
            tbody.innerHTML = '';
            sessionLog.slice(-20).reverse().forEach(log => {
                const layerStr = Object.entries(log.layers).map(([k, v]) => `${k}:${v}`).join(' | ');
                tbody.innerHTML += `
                    <tr>
                        <td>${log.timestamp}</td>
                        <td style="color:#00e676; font-weight:bold;">${log.wrs}</td>
                        <td>${log.cmd}</td>
                        <td>${log.symbol}</td>
                        <td style="font-size:11px;">${layerStr}</td>
                    </tr>
                `;
            });
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        function downloadLog() {
            const json = JSON.stringify(sessionLog, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nice_log_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
        }
        
        // Ï¥àÍ∏∞ Î°úÎìú
        updateAnalysis();
        setInterval(updateAnalysis, 60000);
    </script>
</body>
</html>